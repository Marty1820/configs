#!/bin/sh

status() {  
  # Check if Wi-Fi is blocked (airplane mode)
  if rfkill list wifi 2>/dev/null | grep -q "Soft blocked: yes"; then
    printf '{"icon":"","class":"blocked","name":"Airplane Mode"}\n'
    return
  fi

  # Find fist Wi-Fi device
  iface=$(nmcli -t -f DEVICE,TYPE device status | \
    awk -F: '$2=="wifi"{print $1; exit}')
  name=""
  icon=""
  cls=""

  if [ -z "$iface" ]; then
    name="No Wi-Fi Device"
    icon=""
    cls="blocked"
  else
    # Get active Wi-Fi connection
    name=$(nmcli -t -f NAME,DEVICE connection show --active | \
      awk -F: -v dev="$iface" '$2==dev{print $1; exit}')
    if [ -n "$name" ]; then
      # Get Wi-Fi strength (0–100)
      strength=$(nmcli -t -f IN-USE,SIGNAL device wifi list | awk -F: '/^\*/ {print $2; exit}')
      case $strength in
        8[0-9]|9[0-9]|100)    icon="󰤨" ;;  # strong
        6[0-9]|7[0-9])        icon="󰤥" ;;  # good
        3[0-9]|4[0-9]|5[0-9]) icon="󰤢" ;; # weak
        [1-9]|[1-2][0-9])     icon="󰤟" ;;  # very weak
        *)                    icon="󰤯" ;;  # unknown
      esac
      cls="up"
    else
      # Check wired before declaring disconnected
      eth_iface=$(nmcli -t -f DEVICE,TYPE device status | \
        awk -F: '$2=="ethernet"{print $1; exit}')
      if [ -n "$eth_iface" ] && nmcli -t -f DEVICE,STATE device status | grep -q "^$eth_iface:connected"; then
        name="Wired"
        icon="󰈀"
        cls="wired"
      else
        name="Disconnected"
        icon="󰤭"
        cls="down"
      fi
    fi
  fi

  printf '{"icon":"%s","class":"%s","name":"%s"}\n' \
    "$icon" "$cls" "$name"
}

# Update on changes
nmcli -t monitor | while read -r _; do
  status
done
